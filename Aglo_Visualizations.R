dev.off()
cat("\014")
rm(list=ls())
set.seed(18552)

library(ggplot2)
library(tidyverse)
library(readxl)
library(ggeffects)
library(ggrepel)
library(networkD3)
library(dplyr)

setwd("~/Documents")
cluster1x <- read_excel("cluster1.xlsx")

data1 <- read.csv("Purchase_Card_Transactions.csv")
cluster1 <- subset(data1, data1$AGENCY == 'Board of Real Property Assessment & Appeals' | data1$AGENCY == 'Contract Appeals Board' | data1$AGENCY == 'Office of Employee Appeals' | data1$AGENCY == 'Public Employee Relations Board')
BRPA <- subset(cluster1, cluster1$AGENCY == 'Board of Real Property Assessment & Appeals')
CAB <- subset(cluster1, cluster1$AGENCY == 'Contract Appeals Board')
OEA <- subset(cluster1, cluster1$AGENCY == 'Office of Employee Appeals')
PERB <- subset(cluster1, cluster1$AGENCY == 'Public Employee Relations Board')

BRPAavg <- mean(BRPA$TRANSACTION_AMOUNT)
CABavg <- mean(CAB$TRANSACTION_AMOUNT)
OEAavg <- mean(OEA$TRANSACTION_AMOUNT)
PERBavg <- mean(PERB$TRANSACTION_AMOUNT)
totalavg <- mean(data1$TRANSACTION_AMOUNT)
c1avg <- mean(cluster1$TRANSACTION_AMOUNT)

ggplot(data=cluster1x, aes(x=Transactions,y=Mean1))+
  geom_point(color = "blue", size = 3)+
  ggtitle("Sample Cluster Companies' Spending Habits")+
  labs(y = "Mean Transaction Amount",x="# of Transactions")+
  geom_hline(yintercept = 634.9)+
  geom_label_repel(aes(label = Agency),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50')+
  theme_classic()

links <- data.frame(
  source=c('A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 1',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 2',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 3',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 4',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 5',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 6',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 7',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 8',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 9',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10',
           'A_Cluster 10'), 
  target=c('V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10',
           'V_Cluster 1',
           'V_Cluster 2',
           'V_Cluster 3',
           'V_Cluster 4',
           'V_Cluster 5',
           'V_Cluster 6',
           'V_Cluster 7',
           'V_Cluster 8',
           'V_Cluster 9',
           'V_Cluster 10'), 
  value=c(1.00498578e-02, 1.40484963e-02, 2.16333611e-03, 1.56739765e-02,
          2.96954961e-02, 7.37016605e-02, 3.45579184e-03, 1.96158601e-04,
          2.13801814e-04, 3.72440851e-03, 9.35379498e-03, 2.33207403e-02,
          6.97221327e-02, 3.11481230e-04, 8.53582159e-03, 7.98999557e-03,
          8.55028759e-03, 9.36821540e-04, 2.45571816e-03, 2.13510967e-02,
          3.12300997e-02, 1.91676366e-02, 9.18712372e-02, 5.70153987e-04,
          2.65721849e-03, 1.54112512e-02, 1.28998149e-02, 1.08140936e-03,
          3.01866007e-03, 1.75843753e-02, 5.73266100e-03, 8.48645885e-03,
          7.52036624e-02, 0.00000000e+00, 2.69146251e-04, 3.19764059e-02,
          3.00969547e-02, 1.33100570e-03, 4.03763607e-04, 1.48937907e-02,
          2.12205573e-02, 1.56376831e-02, 6.22764884e-02, 6.28930413e-04,
          6.90606219e-03, 1.52505146e-02, 1.15552146e-02, 7.95113790e-04,
          2.03861722e-03, 1.46579457e-02, 3.57331686e-02, 8.13660071e-03,
          6.42728627e-02, 5.43007671e-03, 1.08030272e-02, 8.69538443e-03,
          4.29969753e-03, 2.73023607e-03, 3.14601778e-03, 2.13140907e-02,
          1.03867557e-02, 2.61448216e-02, 5.00695865e-02, 1.16257789e-03,
          3.02202687e-03, 7.09890368e-03, 2.05685765e-02, 5.49646991e-04,
          1.92677896e-03, 2.37801125e-02, 3.38578454e-02, 0.00000000e+00,
          7.89947826e-02, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,
          0.00000000e+00, 1.95853619e-04, 3.56161800e-04, 0.00000000e+00,
          1.02200083e-02, 7.44249296e-03, 2.94907157e-02, 3.30895524e-05,
          2.59880898e-03, 9.07125359e-03, 3.62166901e-03, 1.71690828e-04,
          1.23198896e-03, 9.96570633e-03, 0.00000000e+00, 1.54275227e-02,
          8.92785416e-02, 3.88475628e-02, 0.00000000e+00, 0.00000000e+00,
          0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 8.89350643e-04))

nodes <- data.frame(
  name=c(as.character(links$source), 
         as.character(links$target)) %>% unique()
)

links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

p <- sankeyNetwork(Links = links, Nodes = nodes,
                   Source = "IDsource", Target = "IDtarget",
                   Value = "value", NodeID = "name", 
                   sinksRight=FALSE)
p

# save the widget
library(htmlwidgets)
saveWidget(p, file = "~/Documents/sankeyBasic1.html")
